---
title: "Linuxé©±åŠ¨å¼€å‘ å­—ç¬¦è®¾å¤‡" # <--- ä¿®æ”¹è¿™ä¸€è¡Œ
date: "2025-11-17T15:53:29+08:00"
draft: false
tags: ["Linux", "é©±åŠ¨å¼€å‘"]
location: "å¹¿å·"
---

## ğŸŒŸ æ ¸å¿ƒæ¦‚å¿µï¼šä»€ä¹ˆæ˜¯å­—ç¬¦è®¾å¤‡ï¼Ÿ

åœ¨ Linux çš„ä¸–ç•Œé‡Œï¼Œ**ä¸€åˆ‡çš†æ–‡ä»¶**ã€‚
å­—ç¬¦è®¾å¤‡ï¼ˆCharacter Deviceï¼‰å°±æ˜¯**åƒæ°´æµä¸€æ ·ï¼ŒæŒ‰é¡ºåºä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚ä¼ è¾“æ•°æ®çš„è®¾å¤‡**ã€‚

- **ä¾‹å­**ï¼šé”®ç›˜ã€é¼ æ ‡ã€ä¸²å£ã€LED ç¯ã€èœ‚é¸£å™¨ã€‚
- **ç›®çš„**ï¼šä½ çš„é©±åŠ¨ç¨‹åºè¦æŠŠç¡¬ä»¶ä¼ªè£…æˆä¸€ä¸ªæ–‡ä»¶ï¼ˆä¾‹å¦‚ `/dev/my_led`ï¼‰ï¼Œè®©åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ `open`ã€`read`ã€`write` è¿™äº›æ ‡å‡†å‡½æ•°æ¥æ§åˆ¶ç¡¬ä»¶ã€‚

---

## ğŸ—ï¸ ç¬¬ä¸€å…³ï¼šä¼ ç»ŸåŠŸå¤« â€”â€” æ‰‹åŠ¨æ‰“é€ å­—ç¬¦è®¾å¤‡é©±åŠ¨

**(çŸ¥è¯†ç‚¹ï¼šç”³è¯·è®¾å¤‡å·ã€æ³¨å†Œ cdevã€cdev_add)**

#### ğŸ—£ï¸ é€šä¿—è®²è§£

ä½ è¦åœ¨ Linux å†…æ ¸é‡Œå¼€ä¸€å®¶â€œåº—â€ï¼ˆé©±åŠ¨ï¼‰ï¼Œå¿…é¡»åŠä¸¤ä»¶äº‹ï¼š

1.  **ç”³è¯·è¥ä¸šæ‰§ç…§ï¼ˆè®¾å¤‡å·ï¼‰**ï¼š
    - **ä¸»è®¾å¤‡å·**ï¼šä»£è¡¨è¡Œä¸šï¼ˆæ¯”å¦‚â€œè¿™æ˜¯ LED è¡Œä¸šâ€ï¼‰ã€‚
    - **æ¬¡è®¾å¤‡å·**ï¼šä»£è¡¨å…·ä½“åˆ†åº—ï¼ˆæ¯”å¦‚â€œè¿™æ˜¯ LED 1 å·åº—ï¼Œé‚£æ˜¯ LED 2 å·åº—â€ï¼‰ã€‚
    - _é™æ€ç”³è¯·è®¾å¤‡å·_ï¼š`register_chrdev_region`ï¼ˆç”³è¯·å‰éœ€è¦`MKDEV(major, minor)`ä¼ å…¥ä¸»æ¬¡è®¾å¤‡å·ï¼‰ã€‚
    - _åŠ¨æ€ç”³è¯·è®¾å¤‡å·_ï¼š`alloc_chrdev_region`ï¼ˆè®©å†…æ ¸è‡ªåŠ¨åˆ†é…ä¸€ä¸ªæ²¡è¢«å ç”¨çš„å·ç ï¼Œæ›´å®‰å…¨ï¼‰ã€‚
2.  **å…³è”å…·ä½“æ“ä½œä¸è¥ä¸šæ‰§ç…§**ï¼š

    - æ‹¿åˆ°æ‰§ç…§åï¼Œä½ è¦å‘Šè¯‰å·¥å•†å±€(å†…æ ¸)ï¼Œé¡¾å®¢æ¥äº†èƒ½åšä»€ä¹ˆã€‚æ¯”å¦‚ï¼Œå¯ä»¥â€œå¼€é—¨â€(`open`)ï¼Œâ€œè¯»å–å•†å“ä¿¡æ¯â€(`read`)ï¼Œâ€œä¸‹å•â€(write)ã€‚è¿™äº›æ“ä½œçš„é›†åˆï¼Œå°±æ˜¯ä¸€ä¸ª `file_operations` ç»“æ„ä½“ã€‚æˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªç»“æ„ä½“å’Œè®¾å¤‡å·å…³è”èµ·æ¥ï¼Œè¿™ä¸ªè¿‡ç¨‹å«æ³¨å†Œå­—ç¬¦è®¾å¤‡ (`cdev`)ã€‚

### ğŸ’» ä»£ç å®è·µ

è¿™æ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„é©±åŠ¨éª¨æ¶ï¼ŒåŠ è½½åå†…æ ¸é‡Œæœ‰äº†ä½ çš„ä½ç½®ï¼Œä½†è¿˜æ²¡æœ‰æ–‡ä»¶èŠ‚ç‚¹ã€‚

```c
#include <linux/module.h>
#include <linux/init.h>
#include <linux/fs.h>
#include <linux/cdev.h>

// å®šä¹‰è®¾å¤‡å
#define DEV_NAME "test_chrdev"

// å…¨å±€å˜é‡
static dev_t dev_num;       // å­˜æ”¾ç”³è¯·åˆ°çš„è®¾å¤‡å·(ä¸»+æ¬¡)
static struct cdev my_cdev; // å­—ç¬¦è®¾å¤‡æ ¸å¿ƒç»“æ„ä½“

// 1. å®šä¹‰æ–‡ä»¶æ“ä½œé›† (åº—å‘˜çš„å·¥ä½œæ‰‹å†Œ)
// ç›®å‰ä»€ä¹ˆéƒ½ä¸åšï¼Œåªæ˜¯ä¸ºäº†ç¼–è¯‘é€šè¿‡
static int my_open(struct inode *inode, struct file *file) {
    printk("è¿…ä¸ºRK3568: è®¾å¤‡è¢«æ‰“å¼€äº†\n");
    return 0;
}

static struct file_operations my_fops = {
        /* é¡¾å®¢æ¥äº†èƒ½åšä»€ä¹ˆ,å®šä¹‰å•†åº—çš„ç»è¥æ–¹æ³• */
    .owner = THIS_MODULE,
    .open = my_open,
};

// 2. é©±åŠ¨å…¥å£ (å¼€ä¸š)
static int __init my_driver_init(void) {
    int ret;

    // A. åŠ¨æ€ç”³è¯·è®¾å¤‡å·
    // å‚æ•°: å­˜æ”¾ç»“æœçš„æŒ‡é’ˆ, æ¬¡è®¾å¤‡å·èµ·å§‹(0), ç”³è¯·æ•°é‡(1), åå­—
    ret = alloc_chrdev_region(&dev_num, 0, 1, DEV_NAME);
    if (ret < 0) {
        printk("ç”³è¯·è®¾å¤‡å·å¤±è´¥\n");
        return ret;
    }
    printk("ç”³è¯·æˆåŠŸ: ä¸»è®¾å¤‡å·=%d, æ¬¡è®¾å¤‡å·=%d\n", MAJOR(dev_num), MINOR(dev_num));

    // B. åˆå§‹åŒ–cdev (ç»‘å®šæˆ‘ä»¬è¦ç”¨çš„æ“ä½œå‡½æ•°é›†)
    cdev_init(&my_cdev, &my_fops);

    // C. æ·»åŠ cdevåˆ°å†…æ ¸ (æ­£å¼æ³¨å†Œ)
    ret = cdev_add(&my_cdev, dev_num, 1);
    if (ret < 0) {
        printk("æ³¨å†Œcdevå¤±è´¥\n");
        unregister_chrdev_region(dev_num, 1); // å¤±è´¥äº†è®°å¾—é€€è¿˜è®¾å¤‡å·
        return ret;
    }

    printk("å­—ç¬¦è®¾å¤‡æ³¨å†Œå®Œæˆï¼\n");
    return 0;
}

// 3. é©±åŠ¨å‡ºå£ (å…³é—¨)
static void __exit my_driver_exit(void) {
    // A. åˆ é™¤cdev
    cdev_del(&my_cdev);
    // B. å½’è¿˜è®¾å¤‡å·
    unregister_chrdev_region(dev_num, 1);
    printk("å­—ç¬¦è®¾å¤‡å·²å¸è½½\n");
}

module_init(my_driver_init);
module_exit(my_driver_exit);
MODULE_LICENSE("GPL");
```

---

## ğŸšª ç¬¬äºŒå…³ï¼šè‡ªåŠ¨æŒ‚ç‰Œ â€”â€” åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹

**(çŸ¥è¯†ç‚¹ï¼šclass_create, device_create)**

### ğŸ—£ï¸ é€šä¿—è®²è§£

åœ¨ç¬¬ä¸€å…³ï¼Œä½ çš„åº—æ³¨å†Œäº†ï¼Œä½†æ˜¯åœ¨è¡—é“ä¸Šï¼ˆ`/dev/` ç›®å½•ï¼‰æ²¡æœ‰é—¨ç‰Œï¼Œç”¨æˆ·æ‰¾ä¸åˆ°ä½ ã€‚è¿™ä¸ªé—¨ç‰Œå°±æ˜¯` /dev` ç›®å½•ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯”å¦‚` /dev/mydevice`.æˆ‘ä»¬å¸Œæœ›åŠ è½½é©±åŠ¨æ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶èƒ½è‡ªåŠ¨å‡ºç°ï¼›å¸è½½æ—¶ï¼Œè‡ªåŠ¨æ¶ˆå¤±ã€‚

1.  **åˆ›å»ºç±» (`class_create`)**ï¼šåœ¨ `/sys/class` ä¸‹å»ºä¸ªåˆ†ç±»ç›®å½•ã€‚ ç›¸å½“äºåˆ›å»ºä¸€æ¡å•†ä¸šè¡—
2.  **åˆ›å»ºè®¾å¤‡ (`device_create`)**ï¼šåœ¨åˆ†ç±»ä¸‹å»ºä¸ªè®¾å¤‡ä¿¡æ¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨ `/dev` ä¸‹ç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶ã€‚åœ¨å•†ä¸šè¡—ä¸Šåˆ›å»ºæˆ‘ä»¬çš„â€œåº—é¢â€ï¼Œå¹¶å–å

### ğŸ’» ä»£ç å®è·µ

åœ¨ç¬¬ä¸€å…³çš„åŸºç¡€ä¸Šï¼Œå¢åŠ è‡ªåŠ¨åˆ›å»ºèŠ‚ç‚¹çš„ä»£ç ã€‚

```c
// ... (ä¿ç•™ä¸Šé¢çš„å¤´æ–‡ä»¶å’Œå˜é‡)
#include <linux/device.h> // æ–°å¢å¤´æ–‡ä»¶

static struct class *my_class;   // ç±»
static struct device *my_device; // è®¾å¤‡

static int __init my_driver_init(void) {
    // ... (alloc_chrdev_region å’Œ cdev_add ä»£ç åŒä¸Šï¼Œçœç•¥) ...

    // 1. åˆ›å»ºç±» (ä¼šåœ¨ /sys/class/ ä¸‹ç”Ÿæˆ my_class_test ç›®å½•)
    // åˆ›å»ºä¸€æ¡â€œå•†ä¸šè¡—â€
    my_class = class_create(THIS_MODULE, "my_class_test");
    if (IS_ERR(my_class)) {
        return PTR_ERR(my_class);
    }

    // 2. åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ (ä¼šåœ¨ /dev/ ä¸‹ç”Ÿæˆ my_device_node æ–‡ä»¶)
    // åœ¨å•†ä¸šè¡—ä¸Šåˆ›å»ºæˆ‘ä»¬çš„â€œåº—é¢â€ï¼Œå¹¶å–å "my_device_node"
    // å‚æ•°: ç±», çˆ¶è®¾å¤‡(NULL), è®¾å¤‡å·, ç§æœ‰æ•°æ®(NULL), è®¾å¤‡å
    my_device = device_create(my_class, NULL, dev_num, NULL, "my_device_node");
    if (IS_ERR(my_device)) {
        class_destroy(my_class); // å¤±è´¥äº†è¦å›æ»š
        return PTR_ERR(my_device);
    }

    printk("è®¾å¤‡èŠ‚ç‚¹ /dev/my_device_node å·²è‡ªåŠ¨ç”Ÿæˆ\n");
    return 0;
}

static void __exit my_driver_exit(void) {
    // --- æ–°å¢æ­¥éª¤ 3.é”€æ¯è®¾å¤‡èŠ‚ç‚¹ (æ³¨æ„é¡ºåºï¼šå…ˆé”€æ¯è®¾å¤‡ï¼Œå†é”€æ¯ç±») ---
    device_destroy(my_class, dev_num);
    class_destroy(my_class);

    // 2.æ³¨é”€å­—ç¬¦è®¾å¤‡
    cdev_del(&my_cdev);
    // 1.å½’è¿˜è®¾å¤‡å·
    unregister_chrdev_region(dev, 1);
    printk(KERN_INFO "----------------MyDevice: åº—é“ºå·²æ‘˜ç‰Œï¼Œæ‰“çƒŠäº†ï¼\n");
}
```

**éªŒè¯**ï¼šåŠ è½½é©±åŠ¨åï¼Œç›´æ¥ `ls /dev/my_device_node`ï¼Œä½ ä¼šå‘ç°æ–‡ä»¶å·²ç»å­˜åœ¨äº†ã€‚

---

## ğŸ“¦ ç¬¬ä¸‰å…³ï¼šæ•°æ®æ¬è¿ â€”â€” ç”¨æˆ·ä¸å†…æ ¸çš„äº¤äº’

**(çŸ¥è¯†ç‚¹ï¼šcopy_to_user, copy_from_user)**

### ğŸ—£ï¸ é€šä¿—è®²è§£

Linux ä¸ºäº†å®‰å…¨ï¼ŒæŠŠå†…å­˜åˆ’åˆ†ä¸º**ç”¨æˆ·ç©ºé—´**ï¼ˆAPPï¼‰å’Œ**å†…æ ¸ç©ºé—´**ï¼ˆé©±åŠ¨ï¼‰ã€‚å®ƒä»¬ä¹‹é—´æœ‰ä¸€å µå¢™ï¼Œä¸èƒ½ç›´æ¥äº’ä¼ æŒ‡é’ˆã€‚

- **APP å†™æ•°æ®ç»™é©±åŠ¨ (`write`)**ï¼šé©±åŠ¨å¿…é¡»ç”¨ `copy_from_user` æŠŠæ•°æ®ä»å¢™å¤–æ‹‰è¿›æ¥ã€‚é¡¾å®¢ï¼ˆç”¨æˆ·ï¼‰æŠŠä¸œè¥¿ç»™ä»“åº“ï¼ˆå†…æ ¸ï¼‰

```c
 copy_from_user(void *to, const void __user *from, unsigned long n)
// to: ç»™è°ï¼Ÿä»ç”¨æˆ·ç©ºé—´æ‹¿æ¥æ•°æ®è¦ç»™è°ï¼Ÿå½“ç„¶æ˜¯å†…æ ¸ç©ºé—´äº†ã€‚ kbuf(ä»“åº“è‡ªå·±çš„ç®±å­)ï¼šç›®çš„åœ°ã€‚

// from:ä»å“ªé‡Œæ¥ï¼Ÿå½“ç„¶æ˜¯ä»ç”¨æˆ·ç©ºé—´æ¥äº†ã€‚ buf (é¡¾å®¢æ‰‹é‡Œçš„ç®±å­)ï¼šæºå¤´ã€‚ç”¨æˆ·ç©ºé—´çš„æ•°æ®åœ°å€ã€‚

// size (æ•°é‡)ï¼šè¦æ‹¿å¤šå°‘ä¸ªè‹¹æœã€‚
```

- **é©±åŠ¨å‘æ•°æ®ç»™ APP (`read`)**ï¼šé©±åŠ¨å¿…é¡»ç”¨ `copy_to_user` æŠŠæ•°æ®æ‰”åˆ°å¢™å¤–å»ã€‚ä»“åº“ï¼ˆå†…æ ¸ï¼‰æŠŠä¸œè¥¿ç»™é¡¾å®¢ï¼ˆç”¨æˆ·ï¼‰ã€‚

- `copy_from_user` å’Œ `copy_to_user` æ˜¯å¯¹é©±åŠ¨è€Œè¨€ï¼›`read` å’Œ `write` æ˜¯å¯¹ç”¨æˆ·è€Œè¨€

### ğŸ’» ä»£ç å®è·µ

å®ç°ä¸€ä¸ªç®€å•çš„è¯»å†™å›æ˜¾åŠŸèƒ½ã€‚

```c
#include <linux/uaccess.h> // å¿…é¡»åŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶

static char kbuf[128] = {0}; // å†…æ ¸é‡Œçš„ç¼“å†²åŒº

// è¯»å‡½æ•°ï¼šAPPè¯»å–æ—¶è°ƒç”¨
static ssize_t my_read(struct file *file, char __user *buf, size_t size, loff_t *ppos) {
    // copy_to_user(ç”¨æˆ·åœ°å€, å†…æ ¸åœ°å€, é•¿åº¦)
    // è¿”å›å€¼ï¼šæ²¡æ‹·è´æˆåŠŸçš„å­—èŠ‚æ•°ï¼Œ0è¡¨ç¤ºå…¨æˆåŠŸ
    int ret = copy_to_user(buf, kbuf, size);
    if(ret) {
        return -EFAULT;
    }
    printk("APPè¯»èµ°äº†æ•°æ®: %s\n", kbuf);
    return size;
}

// å†™å‡½æ•°ï¼šAPPå†™å…¥æ—¶è°ƒç”¨
static ssize_t my_write(struct file *file, const char __user *buf, size_t size, loff_t *ppos) {
    // copy_from_user(å†…æ ¸åœ°å€, ç”¨æˆ·åœ°å€, é•¿åº¦)
    int ret = copy_from_user(kbuf, buf, size);
    if(ret) {
        return -EFAULT;
    }
    printk("APPå†™å…¥äº†æ•°æ®: %s\n", kbuf);
    return size;
}

// è®°å¾—æŠŠè¿™ä¸¤ä¸ªå‡½æ•°å¡«å…¥ file_operations ç»“æ„ä½“
static struct file_operations my_fops = {
    .owner = THIS_MODULE,
    .open = my_open,
    .read = my_read,
    .write = my_write,
};
```

---

## ğŸš€ ç¬¬å››å…³ï¼šæç®€æ¨¡å¼ â€”â€” æ‚é¡¹è®¾å¤‡é©±åŠ¨ (Misc Device)

**(çŸ¥è¯†ç‚¹ï¼šmisc_register)**

### ğŸ—£ï¸ é€šä¿—è®²è§£

å¦‚æœä½ è§‰å¾—ä¸Šé¢çš„ `alloc_chrdev` -> `cdev` -> `class` -> `device` è¿™ä¸€å¥—æµç¨‹å¤ªç¹çäº†ï¼ŒLinux æä¾›äº†ä¸€ä¸ª**æ‡’äººåŒ…**ï¼š**æ‚é¡¹è®¾å¤‡ (Misc Device)**ã€‚

- å®ƒè‡ªåŠ¨å›ºå®šä¸»è®¾å¤‡å·ä¸º **10**ã€‚
- å®ƒè‡ªåŠ¨å¸®ä½ ç”³è¯·æ¬¡è®¾å¤‡å·ã€‚
- å®ƒè‡ªåŠ¨å¸®ä½ åˆ›å»º `/dev/` ä¸‹çš„èŠ‚ç‚¹ã€‚
- **éå¸¸é€‚åˆ**ï¼šç®€å•çš„å­—ç¬¦è®¾å¤‡ï¼ˆèœ‚é¸£å™¨ã€çœ‹é—¨ç‹—ã€ADC ç­‰ï¼‰ã€‚

### ğŸ’» ä»£ç å®è·µ

ä½ ä¼šå‘ç°ä»£ç é‡ç¬é—´å‡å°‘ã€‚

```c
#include <linux/module.h>
#include <linux/init.h>
#include <linux/miscdevice.h> // æ ¸å¿ƒå¤´æ–‡ä»¶
#include <linux/fs.h>

// å®šä¹‰æ“ä½œå‡½æ•°
static int my_misc_open(struct inode *inode, struct file *file) {
    printk("Miscè®¾å¤‡è¢«æ‰“å¼€\n");
    return 0;
}

static struct file_operations misc_fops = {
    .owner = THIS_MODULE,
    .open = my_misc_open,
};

// å®šä¹‰æ‚é¡¹è®¾å¤‡ç»“æ„ä½“
static struct miscdevice my_misc_dev = {
    .minor = MISC_DYNAMIC_MINOR, // è‡ªåŠ¨åˆ†é…æ¬¡è®¾å¤‡å·
    .name = "my_misc_test",      // è‡ªåŠ¨ç”Ÿæˆ /dev/my_misc_test
    .fops = &misc_fops,
};

static int __init my_misc_init(void) {
    // ä¸€æ­¥æ³¨å†Œï¼
    int ret = misc_register(&my_misc_dev);
    if (ret < 0) {
        printk("Miscæ³¨å†Œå¤±è´¥\n");
        return ret;
    }
    printk("Miscé©±åŠ¨æ³¨å†ŒæˆåŠŸ\n");
    return 0;
}

static void __exit my_misc_exit(void) {
    // ä¸€æ­¥å¸è½½
    misc_deregister(&my_misc_dev);
    printk("Miscé©±åŠ¨å¸è½½\n");
}

module_init(my_misc_init);
module_exit(my_misc_exit);
MODULE_LICENSE("GPL");
```

---

## ğŸ§© ç¬¬äº”å…³ï¼šé«˜æ‰‹è¿›é˜¶ â€”â€” ç§æœ‰æ•°æ®ä¸ä¸€é©±å¤šç”¨

**(çŸ¥è¯†ç‚¹ï¼šprivate_data, container_of, é¢å‘å¯¹è±¡çš„æ€æƒ³)**

### ğŸ—£ï¸ é€šä¿—è®²è§£

è¿™æ˜¯ä»å…¥é—¨åˆ°è¿›é˜¶æœ€å…³é”®çš„ä¸€æ­¥ã€‚
**é—®é¢˜**ï¼šå¦‚æœ RK3568 æ¿å­ä¸Šæœ‰ 3 ä¸ª LED ç¯ï¼Œéš¾é“æˆ‘è¦å†™ 3 ä¸ªé©±åŠ¨ï¼ˆled1_drv, led2_drv...ï¼‰å—ï¼Ÿ
**ç­”æ¡ˆ**ï¼šå½“ç„¶ä¸ï¼æˆ‘ä»¬è¦å†™**1 ä¸ªé©±åŠ¨**ï¼Œç®¡ç†**3 ä¸ªè®¾å¤‡**ã€‚

**æ€ä¹ˆåšï¼Ÿ**

1.  **å®šä¹‰ä¸€ä¸ªç»“æ„ä½“**ï¼šæŠŠæ¯ä¸ª LED çš„å±æ€§ï¼ˆæ¯”å¦‚ GPIO å·ã€åå­—ï¼‰åŒ…èµ·æ¥ã€‚
2.  **ä½¿ç”¨ `private_data`**ï¼šå½“ APP æ‰“å¼€ `/dev/led1` æ—¶ï¼Œé©±åŠ¨åœ¨ `open` å‡½æ•°é‡Œè¯†åˆ«å‡ºæ˜¯â€œ1 å·ç¯â€ï¼Œç„¶åæŠŠ 1 å·ç¯çš„ç»“æ„ä½“æŒ‡é’ˆå­˜å…¥ `file->private_data` è¿™ä¸ªâ€œèƒŒåŒ…â€é‡Œã€‚
3.  **è¯»å†™æ—¶**ï¼šåœ¨ `write` å‡½æ•°é‡Œï¼Œä»â€œèƒŒåŒ…â€é‡Œæ‹¿å‡ºæ•°æ®ï¼Œå°±çŸ¥é“ç°åœ¨æ“ä½œçš„æ˜¯å“ªä¸ªç¯ï¼Œè€Œä¸ä¼šä¹±å¥—ã€‚

æ²¡é—®é¢˜ï¼è¿™ä¸€å…³ç¡®å®æ˜¯ Linux é©±åŠ¨å¼€å‘ä¸­**ä»æ–°æ‰‹åˆ°è€æ‰‹**çš„åˆ†æ°´å²­ã€‚å¦‚æœåªç”¨å…¨å±€å˜é‡ï¼Œé‚£å«â€œè£¸æœºæ€ç»´â€ï¼›å­¦ä¼šç”¨ `private_data`ï¼Œæ‰ç®—çœŸæ­£æœ‰äº†â€œLinux é©±åŠ¨æ€ç»´â€ã€‚

æˆ‘ä»¬æ¢ä¸€ä¸ªæ›´ç›´è§‚çš„åœºæ™¯ï¼š**ä½é…’åº—**ã€‚

---

### ğŸ¨ é€šä¿—è®²è§£ï¼šå…¨å±€å˜é‡ vs ç§æœ‰æ•°æ®

å‡è®¾ä½ å¼€äº†ä¸€å®¶é…’åº—ï¼ˆé©±åŠ¨ç¨‹åºï¼‰ï¼Œæœ‰ä¸€ä¸ªæˆ¿é—´ï¼ˆå†…å­˜ç¼“å†²åŒºï¼‰ã€‚

#### 1. å…¨å±€å˜é‡çš„åšæ³•ï¼ˆé”™è¯¯ç¤ºèŒƒï¼‰

ä½ é…’åº—é‡Œ**åªæœ‰ä¸€ä¸ª**å…¬å…±å‚¨ç‰©æŸœï¼ˆå…¨å±€å˜é‡ `static char kbuf[128]`ï¼‰ã€‚

- **å®¢äºº Aï¼ˆAPP 1ï¼‰** å…¥ä½ï¼ŒæŠŠä»–çš„ **é’±åŒ…** æ”¾è¿›äº†æŸœå­ã€‚
- **å®¢äºº Bï¼ˆAPP 2ï¼‰** å…¥ä½ï¼ŒæŠŠä»–çš„ **è‡­è¢œå­** æ”¾è¿›äº†åŒä¸€ä¸ªæŸœå­ï¼ˆè¦†ç›–äº†é’±åŒ…ï¼‰ã€‚
- **å®¢äºº A** æƒ³è¦å–å›ä¸œè¥¿ï¼Œç»“æœæ‹¿å‡ºäº†ä¸€åŒ **è‡­è¢œå­**ã€‚
- **åæœ**ï¼šå®¢äººæ‰“èµ·æ¥äº†ï¼Œæ•°æ®ä¹±å¥—äº†ã€‚

#### 2. ç§æœ‰æ•°æ®çš„åšæ³•ï¼ˆprivate_dataï¼‰

Linux å†…æ ¸è®¾è®¡äº†ä¸€å¥—æœºåˆ¶ï¼š

- **Open (åŠç†å…¥ä½)**ï¼šå½“å‰å°ï¼ˆ`open`å‡½æ•°ï¼‰æ¥åˆ°å®¢äººæ—¶ï¼Œç«‹é©¬ç»™å®¢äººåˆ†é…ä¸€ä¸ª**ä¸“å±æˆ¿é—´**ï¼ˆ`kmalloc` ç”³è¯·ä¸€å—å†…å­˜ï¼‰ï¼Œå¹¶æŠŠ**æˆ¿å¡**ï¼ˆå†…å­˜åœ°å€ï¼‰æŒ‚åœ¨å®¢äººçš„æ¡£æ¡ˆï¼ˆ`file`ç»“æ„ä½“ï¼‰ä¸Šçš„ `private_data` å­—æ®µé‡Œã€‚
- **Write/Read (å›æˆ¿é—´åŠäº‹)**ï¼šå®¢äººè¦å­˜å–ä¸œè¥¿æ—¶ï¼Œå¿…é¡»å‡ºç¤ºæ¡£æ¡ˆã€‚é©±åŠ¨é€šè¿‡ `file->private_data` æ‹¿åˆ°æˆ¿å¡ï¼Œæ‰¾åˆ°**åªå±äºè¿™ä¸ªå®¢äººçš„æˆ¿é—´**è¿›è¡Œæ“ä½œã€‚
- **Release (é€€æˆ¿)**ï¼šå®¢äººèµ°çš„æ—¶å€™ï¼Œé©±åŠ¨å›æ”¶æˆ¿å¡ï¼Œå¹¶æ‰“æ‰«æˆ¿é—´ï¼ˆ`kfree` é‡Šæ”¾å†…å­˜ï¼‰ã€‚

**ç»“è®º**ï¼šä¸ç®¡æœ‰å¤šå°‘ä¸ªå®¢äººåŒæ—¶å…¥ä½ï¼Œæ¯ä¸ªäººéƒ½åªåœ¨è‡ªå·±çš„æˆ¿é—´é‡ŒæŠ˜è…¾ï¼Œäº’ä¸å¹²æ‰°ã€‚

---

### ğŸ’» ä»£ç å®æˆ˜ï¼šå¤š APP æ•°æ®éš”ç¦»å®éªŒ

è¿™ä¸ªé©±åŠ¨å®ç°äº†ï¼š**APP 1 å†™å…¥çš„æ•°æ®ï¼Œåªæœ‰ APP 1 èƒ½è¯»åˆ°ï¼›APP 2 å†™å…¥çš„æ•°æ®ï¼Œåªæœ‰ APP 2 èƒ½è¯»åˆ°ã€‚** å³ä½¿å®ƒä»¬æ‰“å¼€çš„æ˜¯åŒä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ `/dev/test_private`ã€‚

#### 1. é©±åŠ¨ä»£ç  (`private_data_drv.c`)

```c
#include <linux/init.h>
#include <linux/module.h>
#include <linux/fs.h>
#include <linux/cdev.h>
#include <linux/device.h>
#include <linux/uaccess.h>
#include <linux/slab.h> // å¿…é¡»åŒ…å«ï¼ä¸ºäº†ä½¿ç”¨ kmalloc å’Œ kfree

// å®šä¹‰è®¾å¤‡å
#define DEV_NAME "test_private"

// æ ¸å¿ƒï¼šå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œä»£è¡¨â€œä¸€ä¸ªå®¢äººçš„ä¸“å±æˆ¿é—´â€
struct session_data {
    char buffer[128]; // å®¢äººçš„ç§æœ‰å‚¨ç‰©æŸœ
};

// å…¨å±€å˜é‡åªç”¨æ¥ç®¡â€œæ‰§ç…§â€å’Œâ€œé—¨ç‰Œâ€ï¼Œä¸ç®¡å…·ä½“æ•°æ®
static dev_t dev_num;
static struct cdev my_cdev;
static struct class *my_class;
static struct device *my_device;

// --- 1. æ‰“å¼€è®¾å¤‡ (åŠç†å…¥ä½) ---
static int my_open(struct inode *inode, struct file *file)
{
    // A. ä¸ºå½“å‰è¿™ä¸ªâ€œå®¢äººâ€ç”³è¯·ä¸€å—ç‹¬ç«‹çš„å†…å­˜ (å¼€ä¸€é—´æ–°æˆ¿)
    // GFP_KERNEL è¡¨ç¤ºæ­£å¸¸çš„å†…æ ¸å†…å­˜åˆ†é…
    struct session_data *new_data = kmalloc(sizeof(struct session_data), GFP_KERNEL);

    if (!new_data) {
        return -ENOMEM; // å†…å­˜ä¸è¶³ï¼Œå…¥ä½å¤±è´¥
    }

    // B. åˆå§‹åŒ–ä¸€ä¸‹å†…å­˜ï¼Œæ¸…é›¶
    memset(new_data, 0, sizeof(struct session_data));

    // C. å…³é”®ï¼ï¼æŠŠæˆ¿é—´é’¥åŒ™(åœ°å€)æŒ‚åœ¨ file->private_data ä¸Š
    // ä»¥åè¿™ä¸ª file æŒ‡é’ˆä¸ç®¡ä¼ ç»™ read è¿˜æ˜¯ writeï¼Œæˆ‘ä»¬éƒ½èƒ½æ‰¾å›è¿™å—å†…å­˜
    file->private_data = new_data;

    printk("é©±åŠ¨æ—¥å¿—: è¿™é‡Œçš„ open è¢«è°ƒç”¨äº†ï¼Œå·²åˆ†é…ç§æœ‰å†…å­˜åœ°å€: %p\n", new_data);
    return 0;
}

// --- 2. å†™å…¥æ•°æ® (å­˜ä¸œè¥¿) ---
static ssize_t my_write(struct file *file, const char __user *buf, size_t size, loff_t *ppos)
{
    int ret;
    // A. å…³é”®ï¼ï¼ä» private_data é‡Œæ‹¿å‡ºå½“äº‹äººçš„ä¸“å±å†…å­˜æŒ‡é’ˆ
    struct session_data *data = (struct session_data *)file->private_data;

    // é˜²æ­¢æº¢å‡º
    if (size > 128) size = 128;

    // B. æŠŠæ•°æ®å†™å…¥åˆ°â€œä»–çš„â€bufferé‡Œï¼Œè€Œä¸æ˜¯å…¨å±€å˜é‡é‡Œ
    ret = copy_from_user(data->buffer, buf, size);
    if (ret) return -EFAULT;

    printk("é©±åŠ¨æ—¥å¿—: å†™å…¥æ•°æ®åˆ°ç§æœ‰å†…å­˜(%p): %s\n", data, data->buffer);
    return size;
}

// --- 3. è¯»å–æ•°æ® (å–ä¸œè¥¿) ---
static ssize_t my_read(struct file *file, char __user *buf, size_t size, loff_t *ppos)
{
    int ret;
    // A. å…³é”®ï¼ï¼æ‹¿å‡ºå½“äº‹äººçš„æŒ‡é’ˆ
    struct session_data *data = (struct session_data *)file->private_data;

    // B. ä»â€œä»–çš„â€bufferé‡Œè¯»æ•°æ®
    ret = copy_to_user(buf, data->buffer, size);
    if (ret) return -EFAULT;

    printk("é©±åŠ¨æ—¥å¿—: ä»ç§æœ‰å†…å­˜(%p)è¯»å–æ•°æ®: %s\n", data, data->buffer);
    return size;
}

// --- 4. å…³é—­è®¾å¤‡ (é€€æˆ¿) ---
static int my_release(struct inode *inode, struct file *file)
{
    // A. å–å‡ºæŒ‡é’ˆ
    struct session_data *data = (struct session_data *)file->private_data;

    // B. é‡Šæ”¾å†…å­˜ (ä¸€å®šè¦åšï¼å¦åˆ™è¿™å—å†…å­˜å°±ä¸¢äº†ï¼Œè¿™å«å†…å­˜æ³„æ¼)
    if (data) {
        printk("é©±åŠ¨æ—¥å¿—: é‡Šæ”¾ç§æœ‰å†…å­˜åœ°å€: %p\n", data);
        kfree(data);
    }

    return 0;
}

// æ“ä½œå‡½æ•°é›†
static struct file_operations my_fops = {
    .owner = THIS_MODULE,
    .open = my_open,
    .read = my_read,
    .write = my_write,
    .release = my_release,
};

// é©±åŠ¨å…¥å£
static int __init my_init(void)
{
    // åŠ¨æ€ç”³è¯·è®¾å¤‡å·
    alloc_chrdev_region(&dev_num, 0, 1, DEV_NAME);

    // åˆå§‹åŒ–cdev
    cdev_init(&my_cdev, &my_fops);
    cdev_add(&my_cdev, dev_num, 1);

    // è‡ªåŠ¨åˆ›å»ºèŠ‚ç‚¹
    my_class = class_create(THIS_MODULE, "private_class");
    my_device = device_create(my_class, NULL, dev_num, NULL, DEV_NAME);

    printk("é©±åŠ¨æ—¥å¿—: é©±åŠ¨åŠ è½½æˆåŠŸï¼Œè®¾å¤‡èŠ‚ç‚¹ /dev/%s\n", DEV_NAME);
    return 0;
}

// é©±åŠ¨å‡ºå£
static void __exit my_exit(void)
{
    device_destroy(my_class, dev_num);
    class_destroy(my_class);
    cdev_del(&my_cdev);
    unregister_chrdev_region(dev_num, 1);
    printk("é©±åŠ¨æ—¥å¿—: é©±åŠ¨å¸è½½æˆåŠŸ\n");
}

module_init(my_init);
module_exit(my_exit);
MODULE_LICENSE("GPL");
```

---

#### 2. æµ‹è¯•åº”ç”¨ç¨‹åº (`app_test.c`)

ä¸ºäº†éªŒè¯æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œä¸¤ä¸ªè¿™ä¸ªç¨‹åºçš„å®ä¾‹ã€‚

```c
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>

int main(int argc, char *argv[])
{
    if (argc != 2) {
        printf("ç”¨æ³•: ./app <è¦å†™å…¥çš„å­—ç¬¦ä¸²>\n");
        return -1;
    }

    int fd = open("/dev/test_private", O_RDWR);
    if (fd < 0) {
        perror("æ‰“å¼€å¤±è´¥");
        return -1;
    }

    char write_buf[128];
    char read_buf[128] = {0};

    // 1. å†™å…¥ç”¨æˆ·ä¼ å…¥çš„å­—ç¬¦ä¸²
    strncpy(write_buf, argv[1], 128);
    printf("[APP] æ­£åœ¨å†™å…¥: %s\n", write_buf);
    write(fd, write_buf, strlen(write_buf));

    // 2. æ¨¡æ‹Ÿä¸€æ®µé•¿æ—¶é—´çš„ç­‰å¾…ï¼Œä¸ºäº†è®©æˆ‘ä»¬æœ‰æ—¶é—´å»è¿è¡Œå¦ä¸€ä¸ªAPP
    printf("[APP] å†™å…¥å®Œæˆã€‚ç°åœ¨ç¡çœ 10ç§’...\n");
    printf("[APP] è¯·èµ¶ç´§å»å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œ ./app <å…¶ä»–å­—ç¬¦ä¸²> æ¥æµ‹è¯•å¹²æ‰°ï¼\n");
    sleep(10);

    // 3. é†’æ¥åè¯»å–æ•°æ®
    printf("[APP] é†’æ¥äº†ï¼Œå‡†å¤‡è¯»å–...\n");
    read(fd, read_buf, 128);
    printf("[APP] è¯»å–åˆ°çš„å†…å®¹: %s\n", read_buf);

    // 4. éªŒè¯
    if (strcmp(write_buf, read_buf) == 0) {
        printf("[APP] æµ‹è¯•æˆåŠŸï¼æ•°æ®æ²¡è¢«åˆ«äººè¦†ç›–ã€‚\n");
    } else {
        printf("[APP] æµ‹è¯•å¤±è´¥ï¼æ•°æ®è¢«åˆ«äººç¯¡æ”¹äº†ï¼\n");
    }

    close(fd);
    return 0;
}
```

---

#### ğŸ§ª å®éªŒæ­¥éª¤ï¼ˆè§è¯å¥‡è¿¹çš„æ—¶åˆ»ï¼‰

è¯·åœ¨æ¿å­ä¸Šæ‰“å¼€ **ä¸¤ä¸ª** ç»ˆç«¯çª—å£ã€‚

1.  **åŠ è½½é©±åŠ¨**ï¼š

    ```bash
    insmod private_data_drv.ko
    ```

2.  **åœ¨ ç»ˆç«¯ A è¿è¡Œ APPï¼ˆå†™å…¥ "AAAAA"ï¼‰**ï¼š

    ```bash
    ./app AAAAA
    ```

    _å®ƒä¼šæç¤ºä½ ï¼šâ€œå†™å…¥å®Œæˆï¼Œç¡çœ  10 ç§’...â€_

3.  **è¿…é€Ÿåœ¨ ç»ˆç«¯ B è¿è¡Œ APPï¼ˆå†™å…¥ "BBBBB"ï¼‰**ï¼š

    ```bash
    ./app BBBBB
    ```

    _å®ƒä¹Ÿä¼šå†™å…¥å¹¶ç¡çœ ã€‚_

4.  **è§‚å¯Ÿç»“æœ**ï¼š
    - å¦‚æœç”¨çš„æ˜¯ **å…¨å±€å˜é‡**ï¼š
      - ç»ˆç«¯ A é†’æ¥åï¼Œè¯»åˆ°çš„ä¼šæ˜¯ "BBBBB"ï¼ˆå› ä¸ºè¢«åæ¥è€…è¦†ç›–äº†ï¼‰ã€‚
    - å¦‚æœç”¨çš„æ˜¯ **private_data**ï¼ˆä¸Šé¢çš„ä»£ç ï¼‰ï¼š
      - ç»ˆç«¯ A é†’æ¥ï¼Œè¯»åˆ°çš„ä¸€å®šæ˜¯ **"AAAAA"**ã€‚
      - ç»ˆç«¯ B é†’æ¥ï¼Œè¯»åˆ°çš„ä¸€å®šæ˜¯ **"BBBBB"**ã€‚

#### ğŸ” ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿï¼ˆåº•å±‚é€»è¾‘ï¼‰

1.  ç»ˆç«¯ A è¿è¡Œ `./app` -> è°ƒç”¨ `open` -> é©±åŠ¨ `kmalloc` äº†ä¸€å—å†…å­˜ï¼ˆå‡è®¾åœ°å€ `0x1000`ï¼‰ï¼ŒæŒ‚åœ¨ A çš„ `file->private_data` ä¸Šã€‚
2.  ç»ˆç«¯ B è¿è¡Œ `./app` -> è°ƒç”¨ `open` -> é©±åŠ¨ **åˆ** `kmalloc` äº†ä¸€å—æ–°å†…å­˜ï¼ˆå‡è®¾åœ°å€ `0x2000`ï¼‰ï¼ŒæŒ‚åœ¨ B çš„ `file->private_data` ä¸Šã€‚
3.  A å†™æ•°æ®ï¼Œå†™åˆ°äº† `0x1000`ã€‚
4.  B å†™æ•°æ®ï¼Œå†™åˆ°äº† `0x2000`ã€‚
5.  A è¯»æ•°æ®ï¼Œé©±åŠ¨ä» A çš„ `file` é‡Œå–å‡º `0x1000`ï¼Œè¯»å‡º "AAAAA"ã€‚

è¿™å°±å®ç°äº†å®Œç¾çš„**æ•°æ®éš”ç¦»**ã€‚è¿™å°±æ˜¯ Linux é©±åŠ¨æ”¯æŒå¤šç”¨æˆ·å¹¶å‘è®¿é—®çš„åŸºç¡€ï¼

---

## æ–°å¢ï¼šå®˜æ–¹æ–‡æ¡£ç§æœ‰æ•°æ®å¤„ç†æ–¹æ³•

**ï¼ˆçŸ¥è¯†ç‚¹ï¼šæŠŠå…¨å±€å˜é‡æ‰“åŒ…ï¼Œå¹¶é€šè¿‡æŒ‡é’ˆä¼ é€’ï¼‰**
`struct device_test dev1`å®šä¹‰åœ¨å‡½æ•°å¤–é¢ï¼Œæ˜¯å…¨å±€å˜é‡ã€‚ç¼–è¯‘çš„æ—¶å€™å†…å­˜å°±åˆ†é…å¥½äº†ï¼Œä¸€ç›´åœ¨é‚£å„¿ã€‚

### åšæ³•

1.  **æ‰“åŒ…**ï¼šä»–ä¸å†é›¶æ•£åœ°å®šä¹‰ `dev_t dev_num`ã€`struct cdev`ã€`char kbuf[]`ï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ªå¤§ç»“æ„ä½“ `struct device_test`ï¼ŒæŠŠæ‰€æœ‰è·Ÿè¿™ä¸ªè®¾å¤‡æœ‰å…³çš„ä¸œè¥¿éƒ½å¡è¿›å»ã€‚å¹¶ä¸”å®šä¹‰äº†ä¸€ä¸ª**å…¨å±€å˜é‡** `struct device_test dev1;`ã€‚
2.  **æŒ‚æ¥**ï¼šåœ¨ `open` å‡½æ•°é‡Œï¼Œä»–æ‰§è¡Œäº† `file->private_data = &dev1;`ã€‚æ„æ€æ˜¯ï¼šæŠŠè¿™ä¸ª**å…¨å±€å˜é‡çš„åœ°å€**æŒ‚åœ¨è¿™ä¸ªæ–‡ä»¶æŒ‡é’ˆä¸Šã€‚
3.  **ä½¿ç”¨**ï¼šåœ¨ `write` å‡½æ•°é‡Œï¼Œä»–ä¸å†ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡å `dev1.kbuf`ï¼Œè€Œæ˜¯å…ˆå–å‡ºæŒ‡é’ˆ `test_dev = file->private_data`ï¼Œå†ç”¨ `test_dev->kbuf` æ¥æ“ä½œã€‚

### whyï¼ˆä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å…¨å±€å˜é‡ `dev1`ï¼Ÿï¼‰

è™½ç„¶åœ¨è¿™ä¸ªç‰¹å®šçš„ç®€å•ä¾‹å­é‡Œï¼Œç›´æ¥ç”¨ `dev1.kbuf` å’Œç”¨ `private_data` æ•ˆæœä¸€æ¨¡ä¸€æ ·ï¼Œä½†ä»–çš„ç›®çš„æ˜¯**ä¸ºäº†è§„èŒƒåŒ–ï¼ˆé¢å‘å¯¹è±¡æ€ç»´ï¼‰**ã€‚

### ä¼˜ç‚¹

å¦‚æœå°†æ¥ä½ çš„æ¿å­ä¸Šæœ‰ 2 ä¸ªå®Œå…¨ä¸€æ ·çš„è®¾å¤‡ï¼ˆæ¯”å¦‚ dev1 å’Œ dev2ï¼‰ã€‚

- å¦‚æœä¸ä½¿ç”¨ `private_data`ï¼šä½ éœ€è¦å†™ä¸¤å¥— write å‡½æ•°ï¼ˆ`write_for_dev1` å’Œ `write_for_dev2`ï¼‰ï¼Œæˆ–è€…åœ¨å‡½æ•°é‡Œå†™å¤§é‡çš„ `if/else`ã€‚
- å¦‚æœä½¿ç”¨ `private_data`ï¼šä½ çš„ `write` å‡½æ•°**ä¸€è¡Œéƒ½ä¸ç”¨æ”¹**ï¼
  - æ‰“å¼€ dev1 æ—¶ï¼Œ`private_data` æŒ‡å‘ `&dev1`ã€‚
  - æ‰“å¼€ dev2 æ—¶ï¼Œ`private_data` æŒ‡å‘ `&dev2`ã€‚
  - `write` å‡½æ•°åªç®¡æ“ä½œæŒ‡é’ˆï¼Œä¸ç®¡å…·ä½“æŒ‡å‘è°ã€‚

**æ€»ç»“å®˜æ–¹ä»£ç ï¼š** å®ƒæ˜¯**é™æ€**çš„ç”¨æ³•ã€‚å®ƒä¸»è¦è§£å†³çš„æ˜¯**â€œé©±åŠ¨ä»£ç é€šç”¨æ€§â€**çš„é—®é¢˜ï¼Œè®©ä¸€å¥—æ“ä½œå‡½æ•°èƒ½æœåŠ¡äºç‰¹å®šçš„ç¡¬ä»¶å¯¹è±¡ã€‚

### åŒºåˆ«å¯¹æ¯”è¡¨

| ç‰¹æ€§            | å®˜æ–¹ä»£ç  (å…¨å±€å˜é‡ &dev1)     | ç¬¬äº”å…³ (kmalloc)                        |
| :-------------- | :---------------------------- | :-------------------------------------- |
| **å†…å­˜æ¥æº**    | å…¨å±€é™æ€åŒº (ç¼–è¯‘æ—¶å†³å®š)       | å †åŒº (è¿è¡Œæ—¶åŠ¨æ€ç”³è¯·)                   |
| **å¤š App æ‰“å¼€** | **å…±äº«åŒä¸€ä¸ªç©ºé—´**            | **æ•°æ®å®Œå…¨éš”ç¦»**                        |
| **æ¯”å–»**        | å…¬å›­çš„é•¿æ¤… (å¤§å®¶ååŒä¸€æŠŠæ¤…å­) | é…’åº—çš„æˆ¿é—´ (æ¯äººå¼€ä¸€é—´æˆ¿)               |
| **é€‚ç”¨åœºæ™¯**    | **ç¡¬ä»¶æ§åˆ¶** (æ¯”å¦‚ LEDã€GPIO) | **è½¯ä»¶ç¼“å†²åŒº** (æ¯”å¦‚è™šæ‹Ÿä¸²å£ã€ç‹¬ç«‹å­˜å‚¨) |

### åœºæ™¯è¿˜åŸï¼šå¦‚æœä¸¤ä¸ª APP åŒæ—¶æ‰“å¼€è®¾å¤‡

- **å®˜æ–¹ä»£ç çš„æƒ…å†µ**ï¼š

  - APP A æ‰“å¼€è®¾å¤‡ -> `private_data` æŒ‡å‘ `&dev1`ã€‚
  - APP B æ‰“å¼€è®¾å¤‡ -> `private_data` æŒ‡å‘ `&dev1`ã€‚
  - **ç»“æœ**ï¼šA å’Œ B æ“ä½œçš„æ˜¯**åŒä¸€å—å†…å­˜**ã€‚A å†™è¿›å»çš„æ•°æ®ï¼ŒB èƒ½è¯»åˆ°ï¼›B å†™è¿›å»çš„æ•°æ®ï¼Œä¹Ÿä¼šè¦†ç›– A çš„æ•°æ®ã€‚
  - **ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ** å› ä¸ºå¯¹äº**ç¡¬ä»¶**æ¥è¯´ï¼Œç‰©ç†ä¸Šåªæœ‰ä¸€ä¸ªã€‚æ¯”å¦‚æ¿å­ä¸Šåªæœ‰ä¸€ä¸ª LED ç¯ï¼Œæ— è®º A è¿˜æ˜¯ B æ¥æ§åˆ¶ï¼Œæ§åˆ¶çš„éƒ½æ˜¯åŒä¸€ä¸ªç‰©ç†å¯„å­˜å™¨ã€‚æ‰€ä»¥è¿™é‡Œçš„ `dev1` ä»£è¡¨çš„æ˜¯é‚£ä¸ª**å”¯ä¸€çš„ç‰©ç†å®ä½“**ã€‚

- **ç¬¬äº”å…³ä»£ç  (`kmalloc`) çš„æƒ…å†µ**ï¼š
  - APP A æ‰“å¼€è®¾å¤‡ -> `kmalloc` ç”³è¯·äº†å†…å­˜å— A -> `private_data` æŒ‡å‘ Aã€‚
  - APP B æ‰“å¼€è®¾å¤‡ -> `kmalloc` ç”³è¯·äº†å†…å­˜å— B -> `private_data` æŒ‡å‘ Bã€‚
  - **ç»“æœ**ï¼šA å’Œ B æ“ä½œçš„æ˜¯**ä¸åŒçš„å†…å­˜**ã€‚äº’ä¸å¹²æ‰°ã€‚
  - **ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ** è¿™ç§é€šå¸¸ç”¨äº**çº¯è½¯ä»¶é©±åŠ¨**æˆ–è€…éœ€è¦**æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ä¸Šä¸‹æ–‡**çš„åœºæ™¯ï¼ˆæ¯”å¦‚æ¯ä¸ªè¿æ¥éƒ½è¦æœ‰ç‹¬ç«‹çš„æ¥æ”¶ç¼“å†²åŒºï¼‰ã€‚

---

## ç¬¬å…­å…³ï¼šä½¿ç”¨ goto è·³è½¬åˆ°é”™è¯¯å¤„ç†å¤„

ä½ å¥½ï¼è¿™ä¸€èŠ‚çš„å†…å®¹éå¸¸å®æˆ˜ï¼Œä¹Ÿæ˜¯åŒºåˆ†â€œå†™ç€ç©â€å’Œâ€œå·¥ä¸šçº§ä»£ç â€çš„é‡è¦æ ‡å‡†ã€‚

åœ¨ Linux å†…æ ¸é‡Œï¼Œèµ„æºï¼ˆå†…å­˜ã€è®¾å¤‡å·ã€èŠ‚ç‚¹ç­‰ï¼‰æ˜¯éå¸¸å®è´µçš„ã€‚å¦‚æœä½ çš„é©±åŠ¨åŠ è½½åˆ°ä¸€åŠå¤±è´¥äº†ï¼Œå´ä¸æŠŠä¹‹å‰ç”³è¯·çš„èµ„æºè¿˜å›å»ï¼Œå°±ä¼šé€ æˆ**èµ„æºæ³„æ¼**ï¼ˆResource Leakï¼‰ã€‚ä¹…è€Œä¹…ä¹‹ï¼Œç³»ç»Ÿå°±ä¼šå› ä¸ºèµ„æºè€—å°½è€Œå´©æºƒã€‚

---

### ğŸ° é€šä¿—æ¯”å–»

å‡è®¾ä½ çš„é©±åŠ¨ç¨‹åºåˆå§‹åŒ–ï¼ˆ`init`ï¼‰å°±åƒå‹‡è€…è¦å»åŸå ¡è§å›½ç‹ï¼Œå¿…é¡»è¿è¿‡ä¸‰é“å…³å¡ï¼š

1.  **ç¬¬ä¸€å…³**ï¼šç”³è¯·è®¾å¤‡å·ï¼ˆæ‹¿é€šè¡Œè¯ï¼‰ã€‚
2.  **ç¬¬äºŒå…³**ï¼šæ³¨å†Œ cdevï¼ˆç™»è®°èº«ä»½ï¼‰ã€‚
3.  **ç¬¬ä¸‰å…³**ï¼šåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼ˆè¿›å…¥å¤§æ®¿ï¼‰ã€‚

#### âŒ å¦‚æœæ²¡æœ‰é”™è¯¯å¤„ç†ï¼ˆè€æµæ°“ï¼‰

- ä½ è¿‡äº†ç¬¬ä¸€å…³ï¼ˆæ‹¿åˆ°é€šè¡Œè¯ï¼‰ã€‚
- ä½ è¿‡äº†ç¬¬äºŒå…³ï¼ˆç™»è®°äº†èº«ä»½ï¼‰ã€‚
- **ç¬¬ä¸‰å…³å¤±è´¥äº†**ï¼ˆå¤§æ®¿é—¨é”åäº†ï¼Œè¿›ä¸å»ï¼‰ã€‚
- **ç»“æœ**ï¼šä½ ç›´æ¥è½¬èº«å›å®¶äº†ã€‚
- **åæœ**ï¼šç”±äºä½ æ²¡é€€è¿˜é€šè¡Œè¯ï¼Œä¹Ÿæ²¡æ³¨é”€èº«ä»½ï¼ŒåŸå ¡åå†Œé‡Œä¸€ç›´æœ‰ä½ ï¼Œä½†å®é™…ä¸Šä½ äººä¸åœ¨ã€‚ä¸‹æ¬¡å†æ¥ç”³è¯·ï¼Œç®¡ç†å‘˜è¯´ï¼šâ€œä½ ä¸æ˜¯å·²ç»åœ¨é‡Œé¢äº†å—ï¼Ÿâ€â€”â€”**è¿™å°±æ˜¯èµ„æºæ³„æ¼/å†²çªã€‚**

#### âœ… æ­£ç¡®çš„é”™è¯¯å¤„ç†ï¼ˆå€’å™æ’¤é”€ï¼‰

- **ç¬¬ä¸‰å…³å¤±è´¥æ—¶**ï¼šä½ ä¸èƒ½ç›´æ¥å›å®¶ã€‚ä½ å¿…é¡»**å€’ç€èµ°å›å»**ã€‚
- **å¤„ç†**ï¼š
  1.  å…ˆå»ç¬¬äºŒå…³ï¼Œæ³¨é”€èº«ä»½ã€‚
  2.  å†å»ç¬¬ä¸€å…³ï¼Œé€€è¿˜é€šè¡Œè¯ã€‚
  3.  æœ€åæ‰èƒ½å›å®¶æŠ¥é”™ã€‚

---

### ğŸ› ï¸ ä¸ºä»€ä¹ˆè¦ç”¨ `goto`ï¼Ÿ

åœ¨ C è¯­è¨€é‡Œï¼Œå¦‚æœæœ‰ 5 ä¸ªæ­¥éª¤ï¼Œç”¨ `if-else` å±‚å±‚åµŒå¥—ä¼šå†™å‡ºâ€œä»£ç é‡‘å­—å¡”â€ï¼Œéå¸¸éš¾çœ‹ä¸”å®¹æ˜“å‡ºé”™ã€‚
Linux å†…æ ¸çº¦å®šä¿—æˆï¼š**ä½¿ç”¨ `goto` è¯­å¥è·³è½¬åˆ°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä»£ç æ®µ**ã€‚

**æ ¸å¿ƒå£è¯€ï¼šå…ˆè¿›åå‡ºï¼ˆFILOï¼‰**

- ç¬¬ 1 ä¸ªç”³è¯·çš„èµ„æºï¼Œè¦åœ¨ **æœ€å€’éœ‰**ï¼ˆæœ€åä¸€æ­¥æ‰å‡ºé”™ï¼‰çš„æ—¶å€™æ‰é‡Šæ”¾ï¼Œæ‰€ä»¥å®ƒçš„é‡Šæ”¾ä»£ç æ”¾åœ¨æœ€ä¸‹é¢ã€‚
- ç¬¬ 3 ä¸ªç”³è¯·çš„èµ„æºï¼Œå¦‚æœåœ¨ç¬¬ 4 æ­¥å‡ºé”™ï¼Œå®ƒæ˜¯ç¬¬ä¸€ä¸ªéœ€è¦è¢«é‡Šæ”¾çš„ã€‚

---

### ğŸ’» ä»£ç å®æˆ˜ï¼šå¸¦é”™è¯¯å¤„ç†çš„é©±åŠ¨æ¡†æ¶

è¯·ä»”ç»†çœ‹ä¸‹é¢ä»£ç ä¸­çš„æ³¨é‡Šï¼Œç‰¹åˆ«æ˜¯ `goto` è·³è½¬çš„ä½ç½®å’Œæ ‡å·çš„é¡ºåºã€‚

```c
#include <linux/init.h>
#include <linux/module.h>
#include <linux/fs.h>
#include <linux/cdev.h>
#include <linux/device.h>
#include <linux/err.h> // å¿…é¡»åŒ…å«ï¼Œç”¨äº IS_ERR å’Œ PTR_ERR

static dev_t dev_num;
static struct cdev my_cdev;
static struct class *my_class;
static struct device *my_device;

static int __init my_driver_init(void)
{
    int ret;

    // --- ç¬¬ä¸€å…³ï¼šç”³è¯·è®¾å¤‡å· ---
    ret = alloc_chrdev_region(&dev_num, 0, 1, "error_test_dev");
    if (ret < 0) {
        printk("ç¬¬ä¸€å…³å¤±è´¥ï¼šç”³è¯·è®¾å¤‡å·æŒ‚äº†\n");
        // ç¬¬ä¸€å…³å°±æŒ‚äº†ï¼Œä¹‹å‰å•¥ä¹Ÿæ²¡å¹²ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸éœ€è¦ goto
        return ret;
    }

    // --- ç¬¬äºŒå…³ï¼šæ³¨å†Œ cdev ---
    cdev_init(&my_cdev, NULL); // è¿™é‡Œçœç•¥fopsä»…åšæ¼”ç¤º
    ret = cdev_add(&my_cdev, dev_num, 1);
    if (ret < 0) {
        printk("ç¬¬äºŒå…³å¤±è´¥ï¼šcdevæ³¨å†ŒæŒ‚äº†\n");
        // è¿™é‡Œå¤±è´¥äº†ï¼Œéœ€è¦æŠŠç¬¬ä¸€å…³ç”³è¯·çš„è®¾å¤‡å·è¿˜å›å»
        goto free_dev_num;
    }

    // --- ç¬¬ä¸‰å…³ï¼šåˆ›å»ºç±» ---
    my_class = class_create(THIS_MODULE, "test_class");
    // æ³¨æ„ï¼šclass_create è¿”å›çš„æ˜¯æŒ‡é’ˆï¼Œåˆ¤æ–­æŒ‡é’ˆé”™è¯¯è¦ç”¨ IS_ERR
    if (IS_ERR(my_class)) {
        printk("ç¬¬ä¸‰å…³å¤±è´¥ï¼šåˆ›å»ºç±»æŒ‚äº†\n");
        ret = PTR_ERR(my_class); // æŠŠæŒ‡é’ˆé”™è¯¯è½¬æ¢æˆé”™è¯¯ç (int)
        // è¿™é‡Œå¤±è´¥äº†ï¼Œè¦æ’¤é”€ç¬¬äºŒå…³(cdev)å’Œç¬¬ä¸€å…³(è®¾å¤‡å·)
        goto del_cdev;
    }

    // --- ç¬¬å››å…³ï¼šåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ ---
    my_device = device_create(my_class, NULL, dev_num, NULL, "test_device");
    if (IS_ERR(my_device)) {
        printk("ç¬¬å››å…³å¤±è´¥ï¼šåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹æŒ‚äº†\n");
        ret = PTR_ERR(my_device);
        // è¿™é‡Œå¤±è´¥äº†ï¼Œè¦æ’¤é”€ç¬¬ä¸‰å…³(ç±»)ã€ç¬¬äºŒå…³(cdev)ã€ç¬¬ä¸€å…³(è®¾å¤‡å·)
        goto destroy_class;
    }

    printk("æ­å–œï¼æ‰€æœ‰å…³å¡å…¨éƒ¨é€šè¿‡ï¼\n");
    return 0;

// ===========================================
// ä¸‹é¢æ˜¯â€œå€’å™â€çš„é”™è¯¯å¤„ç†åŒº
// ===========================================

destroy_class:
    // æ’¤é”€ç¬¬ä¸‰å…³
    class_destroy(my_class);

del_cdev:
    // æ’¤é”€ç¬¬äºŒå…³
    cdev_del(&my_cdev);

free_dev_num:
    // æ’¤é”€ç¬¬ä¸€å…³
    unregister_chrdev_region(dev_num, 1);

    // è¿”å›é”™è¯¯ç ç»™å†…æ ¸ï¼Œå‘Šè¯‰å®ƒåŠ è½½å¤±è´¥
    return ret;
}

static void __exit my_driver_exit(void)
{
    // æ­£å¸¸å¸è½½æ—¶çš„é¡ºåºï¼Œå’Œé”™è¯¯å¤„ç†æ˜¯ä¸€æ ·çš„ï¼šå€’ç€æ‹†
    device_destroy(my_class, dev_num);
    class_destroy(my_class);
    cdev_del(&my_cdev);
    unregister_chrdev_region(dev_num, 1);
    printk("é©±åŠ¨å®‰å…¨å¸è½½\n");
}

module_init(my_driver_init);
module_exit(my_driver_exit);
MODULE_LICENSE("GPL");
```

---

### ğŸ” å…³é”®çŸ¥è¯†ç‚¹è§£é‡Š

1.  **æ ‡ç­¾ï¼ˆLabelï¼‰å‘½åè§„èŒƒ**ï¼š

    - æ ‡ç­¾åé€šå¸¸ä»£è¡¨**â€œåœ¨è¿™ä¸ªåœ°æ–¹è¦åšä»€ä¹ˆæ¸…ç†å·¥ä½œâ€**ã€‚
    - ä¾‹å¦‚ `destroy_class:` æ„å‘³ç€è·³åˆ°è¿™é‡Œæ˜¯ä¸ºäº†é”€æ¯ classã€‚
    - ä¹Ÿæœ‰äººå–œæ¬¢å‘½åä¸º `err_step3`ï¼Œçœ‹ä¸ªäººä¹ æƒ¯ï¼Œå»ºè®®ç”¨åŠ¨è¯æ›´æ¸…æ™°ã€‚

2.  **æ‰§è¡Œæµï¼ˆç€‘å¸ƒæµï¼‰**ï¼š

    - æ³¨æ„çœ‹ `destroy_class:` ä¸‹é¢**æ²¡æœ‰ `break` ä¹Ÿæ²¡æœ‰ `return`**ã€‚
    - è¿™æ„å‘³ç€ï¼Œå¦‚æœä»£ç è·³åˆ°äº† `destroy_class`ï¼Œå®ƒæ‰§è¡Œå®Œ `class_destroy` åï¼Œä¼š**æ¥ç€å¾€ä¸‹æ‰§è¡Œ** `del_cdev`ï¼Œå†æ¥ç€æ‰§è¡Œ `free_dev_num`ã€‚
    - è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼å› ä¸ºå¦‚æœåœ¨ç¬¬ 4 æ­¥å‡ºé”™ï¼Œç¬¬ 3ã€2ã€1 æ­¥ç”³è¯·çš„èµ„æºéƒ½éœ€è¦é‡Šæ”¾ã€‚

3.  **IS_ERR å’Œ PTR_ERR**ï¼š
    - æœ‰äº›å‡½æ•°ï¼ˆå¦‚ `class_create`ï¼‰è¿”å›çš„æ˜¯æŒ‡é’ˆã€‚å¦‚æœå¤±è´¥äº†ï¼Œå®ƒä¸ä¼šè¿”å› `NULL`ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„â€œé”™è¯¯æŒ‡é’ˆâ€ï¼ˆæ¯”å¦‚åœ°å€ 0xFFFFFFF0ï¼‰ã€‚
    - **åˆ¤æ–­æ–¹æ³•**ï¼šå¿…é¡»ç”¨ `IS_ERR(ptr)` æ¥åˆ¤æ–­æ˜¯å¦å‡ºé”™ã€‚
    - **è·å–é”™è¯¯ç **ï¼šå¿…é¡»ç”¨ `PTR_ERR(ptr)` æŠŠè¿™ä¸ªæŒ‡é’ˆç¿»è¯‘æˆ `-ENOMEM` ä¹‹ç±»çš„æ•´æ•°é”™è¯¯ç è¿”å›ç»™ `ret`ã€‚
    - (åŸå› )ä¼ é€’çœŸç›¸ï¼šä¸Šå±‚ç³»ç»Ÿï¼ˆæ¯”å¦‚ insmod å‘½ä»¤ï¼‰æ¥æ”¶åˆ° ret è¿”å›çš„ -12 åï¼Œå®ƒä¼šæŸ¥è¡¨ï¼Œç„¶åå¹¶åœ¨å±å¹•ä¸Šæ‰“å°å‡ºç²¾ç¾çš„æŠ¥é”™ä¿¡æ¯ï¼š"Out of memory"ï¼ˆè€Œä¸æ˜¯ä»…ä»…æ˜¾ç¤ºâ€œåŠ è½½å¤±è´¥â€ï¼‰ã€‚
    - ç±»å‹è½¬æ¢ï¼šmy_class æ˜¯æŒ‡é’ˆå˜é‡ï¼Œret æ˜¯æ•´æ•°å˜é‡ã€‚C è¯­è¨€ä¸­ï¼ŒæŒ‡é’ˆä¸èƒ½ç›´æ¥èµ‹å€¼ç»™æ•´æ•°ï¼Œå¿…é¡»é€šè¿‡ PTR_ERR è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢å¹¶è¿˜åŸæ•°å€¼ã€‚

### ğŸš€ æ€»ç»“

è¿™ä¸€èŠ‚çš„æ ¸å¿ƒå°±æ˜¯å­¦ä¼šå†™**â€œåæ‚”è¯â€**ï¼š
**åªè¦å‰é¢çš„æ­¥éª¤æˆåŠŸäº†ï¼Œå½“å‰æ­¥éª¤å¤±è´¥äº†ï¼Œå°±å¿…é¡»ç”¨ `goto` è·³åˆ°å¯¹åº”çš„é”™è¯¯å¤„ç†æ®µï¼ŒæŠŠä¹‹å‰åƒè¿›å»çš„èµ„æºå…¨éƒ¨åå‡ºæ¥ã€‚**

---
